# –î–≤–µ –±–∞—à–Ω–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—â–∏–µ —Ñ–∏–ª—å–º—ã

## –°–∞–≤—á–µ–Ω–∫–æ –Æ—Ä–∏–π –î–º–∏—Ç—Ä–∏–µ–≤–∏—á

# –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏

–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏, —Å–ø–æ—Å–æ–±–Ω–æ–π –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ø-K –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π (–æ—Ü–µ–Ω–æ–∫). –í–∞–∂–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—å, —á—Ç–æ –º–æ—ë —Ä–µ—à–µ–Ω–∏–µ –Ω–∞—Ü–µ–ª–µ–Ω–æ –Ω–∞ retrieval-—Å—Ü–µ–Ω–∞—Ä–∏–∏, —Ç–æ –µ—Å—Ç—å –Ω–∞ –±—ã—Å—Ç—Ä—ã–π –æ—Ç–±–æ—Ä —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–≥–æ —á–∏—Å–ª–∞ –∫–∞–Ω–¥–∏—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª–µ–µ –º–æ—â–Ω—ã–º–∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤—â–∏–∫–∞–º–∏. 

## –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ–Ω–∏–º–∞—é —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –º–æ–¥–µ–ª–∏  
–í—Ö–æ–¥: 

* –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–∏–ø–∞ int  
* K \- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤, –æ–∂–∏–¥–∞–µ–º–æ–µ –Ω–∞ –≤—ã—Ö–æ–¥–µ, —Ç–∏–ø–∞ int

–í—ã—Ö–æ–¥: 

* —Å–ø–∏—Å–æ–∫ —Ç—Ä–æ–µ–∫ \[–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–∞ (int), —Ç–∞—Ä–≥–µ—Ç (float), –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞(String)\] –¥–ª–∏–Ω—ã K

## –ú–µ—Ç—Ä–∏–∫–∏

–ù–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Ñ–∏–ª—å–º –≤ —à–æ—Ä—Ç–ª–∏—Å—Ç, –ø–æ—ç—Ç–æ–º—É –º–µ—Ç—Ä–∏–∫–∏ —Å–ª–µ–¥—É—é—â–∏–µ:

1. **Recall@K** \- –¥–æ–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π –∏—Å—Ç–∏–Ω–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º —Ñ–∏–ª—å–º –ø–æ–ø–∞–ª –≤ —Ç–æ–ø-K   
   $Recall@K \= \frac{1}{N}\sum_{i=1}^{N}I\[rank_i\<K\]$  
     
2. **NDCG@K** \- –ø–æ–ª—å–∑–∞ –æ—Ç –≤—ã–¥–∞—á–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –º–æ–¥–µ–ª–∏, –ø–æ —Å—É—Ç–∏, —Ç–æ—Ç –∂–µ **Recall@K,** –Ω–æ —É—á–∏—Ç—ã–≤–∞—é—â–∏–π –ø–æ–∑–∏—Ü–∏—é –∏—Å—Ç–∏–Ω–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —Ñ–∏–ª—å–º–∞ –≤ —Ç–æ–ø–µ  
   $NDCG@K \= \frac{1}{N}\sum_{i=1}^{N}I\[rank_i\<K\]\frac{1}{log_2(rank_i+2)}$

–ö–æ–Ω–µ—á–Ω–æ –∂–µ, —ç—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å—è—Ç –æ—Ç K. –í —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö retrieval –º–æ–¥–µ–ª—è—Ö –æ–±—ã—á–Ω–æ K –ª–µ–∂–∏—Ç –≥–¥–µ\-—Ç–æ –º–µ–∂–¥—É 2000-3000 (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –Ø–Ω–¥–µ–∫—Å–µ; —Å—Å—ã–ª–æ–∫ –Ω–µ –±—É–¥–µ—Ç \- –º–± NDAüòâ), –Ω–æ –¥–æ —Ç–∞–∫–∏—Ö –º–∞—Å—à—Ç–∞–±–æ–≤ –≤—ã–¥–∞—á—É –º–æ–¥–µ–ª–∏ —è –¥–æ–≤–æ–¥–∏—Ç—å –Ω–µ —Ö–æ—á—É. –ü–æ—ç—Ç–æ–º—É, –Ω–∞–ø—Ä–∏–º–µ—Ä, **Recall@50** \>= 0.25 –±—É–¥–µ—Ç –≤–ø–æ–ª–Ω–µ —Ö–æ—Ä–æ—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, –≤–µ–¥—å, –∏–º–µ—è —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—é –æ—Ü–µ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ö–æ—Ç—è –±—ã –∫–∞–∂–¥—ã–π —á–µ—Ç–≤–µ—Ä—Ç—ã–π —Ä–∞–∑ –ø–æ–ø–∞–¥–∞—Ç—å –≤ –∫—Ä–æ—Ö–æ—Ç–Ω—É—é –ø—è—Ç–∏–¥–µ—Å—è—Ç–∫—É –∑–≤—É—á–∏—Ç –∫—Ä—É—Ç–æ

##   –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç

–ë—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ø–ª–∏—Ç, –∞ –∏–º–µ–Ω–Ω–æ: 

* —Å–æ—Ä—Ç–∏—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ timestamp‚Äô—É  
* –æ—Ç—Å–µ–∫–∞—é —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é  
* –∫–∞–∂–¥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞—Ä–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∏—Å—Ç–∏–Ω–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ 4+/5  
* —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–∫–æ—Ä—ã-—Ç–∞—Ä–≥–µ—Ç—ã –¥–ª—è –ø–∞—Ä—ã \[–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ñ–∏–ª—å–º\] –ø–æ –≤—Å–µ–º —Ñ–∏–ª—å–º–∞–º  
* –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ–≤-—Ç–∞—Ä–≥–µ—Ç–æ–≤ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è —Ä–∞–Ω–≥–∏: $rank_u= |$ { $f: s(u;f) \> s(u;f^+)$ } $|$
* –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–Ω–≥–æ–≤ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏ –∏ –∏—Ö —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –ø–æ –≤—Å–µ–º —é–∑–µ—Ä–∞–º

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Å–∏–º—É–ª–∏—Ä—É–µ—Ç—Å—è –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ: –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ü–µ–Ω–æ–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–æ–≤–æ–º—É —Ñ–∏–ª—å–º—É  
–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–µ–º, —á—Ç–æ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ timestamp‚Äô–∞–º–∏

## –î–∞—Ç–∞—Å–µ—Ç—ã

MovieLens 20M \- —Ä–µ–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç —Å —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏ —Ñ–∏–ª—å–º–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

* 20 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –æ—Ü–µ–Ω–æ–∫  
* 138 —Ç—ã—Å—è—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
* 27 —Ç—ã—Å—è—á —Ñ–∏–ª—å–º–æ–≤  
* –≤–µ—Å–∏—Ç 190 –º–µ–≥–∞–±–∞–π—Ç  
* –∏–∑ –≤–∞–∂–Ω–æ–≥–æ –¥–ª—è –º–æ–µ–π –º–æ–¥–µ–ª–∏ —Ç–∞–º –µ—â—ë –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ü–µ–Ω–∫–∏ –∏ –æ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∏–ª—å–º–∞  
* —Å—Å—ã–ª–∫–∞: [https://grouplens.org/datasets/movielens/20m/](https://grouplens.org/datasets/movielens/20m/)  
* –Ω–∞–º –ø—Ä–æ –Ω–µ–≥–æ –¥–∞–∂–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–∞ –≤—Ç–æ—Ä–æ–º –∫—É—Ä—Å–µ

–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã—Ç–µ–∫–∞—é—Ç –∏–∑ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

* –¥–∞–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ {1, 2, 3, 4, 5}, –Ω–æ —Ö–æ—á—É –≤—ã–¥–µ–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –∏—Ç–æ–≥ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–∏–ª—å–º–æ–º \-\> –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ—Ä–æ–≥ (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É 4\)  
* –ø—Ä–æ–±–ª–µ–º–∞ —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞: –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏ —Ñ–∏–ª—å–º–æ–≤) —Å –º–∏–∑–µ—Ä–Ω—ã–º —á–∏—Å–ª–æ–≤ –æ—Ü–µ–Ω–æ–∫ \-\> –≤—ã—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –∏—Ö –µ—â–µ –æ–¥–Ω–∏–º –Ω–∏–∂–Ω–∏–º –ø–æ—Ä–æ–≥–æ–º (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É 5\)  
* —á–∞—Å—Ç—å —Ñ–∏–ª—å–º–æ–≤ –æ—â—É—Ç–∏–º–æ –ø–æ–ø—É–ª—è—Ä–Ω–µ–µ, –Ω–∞–¥–æ –±—ã —ç—Ç–æ –∏ –Ω–µ –Ω–µ–¥–æ—É—á–µ—Å—Ç—å, –∏ –Ω–µ –ø–µ—Ä–µ—É—á–µ—Å—Ç—å \-\> –≤–∞–∂–Ω–æ –∏–º–µ—Ç—å –±—ç–π–∑–ª–∞–π–Ω –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—Å–º. –Ω–∏–∂–µ)

# –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ë–µ–π–∑–ª–∞–π–Ω

–í—ã–¥–∞—ë—Ç —Ç–æ–ø-K —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö (—Ä–∞–∑—É–º–µ–µ—Ç—Å—è, –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫) —Ñ–∏–ª—å–º–æ–≤ –∏–∑ —Ç—Ä—ç–π–Ω–∞

## –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å

*–ß–µ–º –≤–¥–æ—Ö–Ω–æ–≤–∏–ª—Å—è*:   
–ª–µ–∫—Ü–∏–µ–π –í–æ—Ä–æ–Ω—Ü–æ–≤–∞ –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞ –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –ø–ª—ç–π–ª–∏—Å—Ç–∞ –Ω–∞ —é—Ç—É–±–µ (–∏–∑–≤–∏–Ω—è—é—Å—å, —Ç—É—Ç –æ–ø—è—Ç—å –±–µ–∑ —Å—Å—ã–ª–∫–∏, –Ω–æ –≤–æ—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ç–∞–∫–∞—è –∂–µ –∏–¥–µ—è –¥–ª—è –¥—Ä—É–≥–æ–π –∑–∞–¥–∞—á–∏: [https://arxiv.org/abs/2004.04906](https://arxiv.org/abs/2004.04906))

*–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏*:   
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –±–∞—à–Ω—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—É—á–∞–µ–º—ã–π —ç–º–±—ç–¥–¥–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ –¥–µ—Ñ–æ–ª—Ç—É 64\) \- $E_u$
–¥–æ–∫—É–º–µ–Ω—Ç–Ω–∞—è –±–∞—à–Ω—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—É—á–∞–µ–º—ã–π —ç–º–±—ç–¥–¥–∏–Ω–≥ —Ñ–∏–ª—å–º–∞ (—Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ø–æ –¥–µ—Ñ–æ–ª—Ç—É 64\) \- $E_f$  
—Å–∫–æ—Ä-—Ç–∞—Ä–≥–µ—Ç: $s(u;f)=dot(E_u, E_f)$ \- —Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

*–ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è*:  
–∏–¥–µ–π–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —ç–≤–∞–ª —Å—Ç–∞–¥–∏—é:

* –æ—Ü–µ–Ω–∫–∏ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ {1, 2, 3, 4, 5} –¥–µ–ª—è—Ç—Å—è –Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª—É  $I\[rating \geq threshold\]$ (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É 4\)  
    
* –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä \[–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ñ–∏–ª—å–º\] –≤—ã—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä—ã –≥–¥–µ –ª–∏–±–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏–ª –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –±–æ–ª–µ–µ $min$ $user$ $interactions$ —Ñ–∏–ª—å–º–æ–≤, –ª–∏–±–æ —Ñ–∏–ª—å–º –±—ã–ª –æ—Ü–µ–Ω—ë–Ω –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –±–æ–ª–µ–µ —á–µ–º $min$ $item$ $interactions$ —Ä–∞–∑ (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É –∏ —Ç–æ, –∏ —Ç–æ 5). —ç—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞  
    
* –≤ –∫–∞–∂–¥—É—é —ç–ø–æ—Ö—É –∏–¥—ë—Ç –º–∞–∫—Å–∏–º—É–º $max$ $interactions$ (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É 2 –º–∏–ª–ª–∏–æ–Ω–∞)  
  –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä \[–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ñ–∏–ª—å–º\]. —ç—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã –º–æ–π –Ω–æ—É—Ç–±—É–∫ –Ω–µ —É–º–µ—Ä  
    
* –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞—Ä—ã \[–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ñ–∏–ª—å–º\] –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ø–∞—Ä—ã \[—Ç–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥—Ä—É–≥–æ–π —Ñ–∏–ª—å–º\] –ø–æ –≤—Å–µ–º –¥—Ä—É–≥–∏–º —Ñ–∏–ª—å–º–∞–º. —ç—Ç–∏ –ø–∞—Ä—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–º–∏ (**in-batch negatives**)  
* –¥–ª—è —ç—Ç–æ–≥–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–∞—Ä –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è —Å–∫–æ—Ä—ã-—Ç–∞—Ä–≥–µ—Ç—ã —Å —É—á—ë—Ç–æ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã $T$ (–ø–æ –¥–µ—Ñ–æ–ª—Ç—É 1): $s(u;f)=\frac{dot(E_u, E_f)}{T}$  
* —ç—Ç–∏ —Å–∫–æ—Ä—ã-—Ç–∞—Ä–≥–µ—Ç—ã –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤ —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Ç–µ—Ä–∏ \- –∫—Ä–æ—Å—Å —ç–Ω—Ç—Ä–æ–ø–∏—é

# –í–Ω–µ–¥—Ä–µ–Ω–∏–µ

1\) –§–æ—Ä–º–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å \+ –æ—Ñ–ª–∞–π–Ω-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

* –æ—Ñ–ª–∞–π–Ω —ç—Ç–∞–ø: –ø–æ—Å—á–∏—Ç–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ñ–∏–ª—å–º–æ–≤, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (–≤–µ—Å–∞ –º–æ–¥–µ–ª–∏)  
* –æ–Ω–ª–∞–π–Ω —ç—Ç–∞–ø: –º–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç **MLflow pyfunc** –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è HTTP-—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç/–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ –∫–∞–∫ —ç—Ç–æ –ø–∏—Å–∞–Ω–æ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É —Ñ–∞–π–ª–∞

2\) –§–æ—Ä–º–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: –ª–æ–∫–∞–ª—å–Ω—ã–π python-–ø–∞–∫–µ—Ç

* –¥–∞–Ω–Ω—ã–µ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é **DVC**  
* –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è **MLflow Tracking** —Å–µ—Ä–≤–µ—Ä –Ω–∞ `127.0.0.1:8080` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤

# Setup

–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –Ω–æ–≤—ã–π —á–ª–µ–Ω –º–æ–µ–π –∫–æ–º–∞–Ω–¥—ã –∏–º–µ–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π git –∏ pipx

```bash
git clone https://github.com/aucalka/two-tower-recsys-retrieval
cd two-tower-recsys-retrieval
pipx install poetry
poetry install
poetry run pre-commit install
poetry run pre-commit run -a
```
—ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Å–∫–∞—á–∞—é—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —É—Å—Ç–∞–Ω–æ–≤—è—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç—è—Ç –ø—Ä–µ–∫–æ–º–º–∏—Ç–Ω—ã–π —Ö—É–∫, —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ–±—É–µ–º—ã—Ö (–Ω–∞–¥–µ—é—Å—å) –±–∞–∑–æ–≤—ã—Ö —Ö—É–∫–æ–≤ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ `.pre-commit-config.yaml`) 

# Train

–¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º MLflow Tracking —Å–µ—Ä–≤–µ—Ä –Ω–∞ `127.0.0.1:8080` (—á—Ç–æ–±—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–ª–∏—Å—å)

–∫–∞–∫ —è –ø–æ–Ω—è–ª, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω —É–∂–µ –ø–æ–¥–Ω—è—Ç, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≤–æ—Ç –∫–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
```bash
poetry run mlflow server --host 127.0.0.1 --port 8080
```
**–í–ù–ò–ú–ê–ù–ò–ï** –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω—É–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–π—Ç–∏ –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è:
```bash
poetry run python -m two_tower_recsys.pipelines.train_pipeline
```
—Ö–æ—á—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ —Ç–æ–º, —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è:

* —Å–∫–∞—á–∞–µ—Ç—Å—è —Å—ã—Ä–æ–π –¥–∞—Ç–∞—Å–µ—Ç MovieLens 20M —á–µ—Ä–µ–∑ DVC (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ)
* –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ data/processed/*
* —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
* –∑–∞–ª–æ–≥–∏—Ä—É—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏/–≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ MLflow Tracking (UI: [127.0.0.1:8080](http://127.0.0.1:8080))
* —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ artifacts/
* —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏ –≤ plots/

–∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –º–æ–∂–Ω–æ –≤–æ—Ç —Ç–∞–∫ (—Ç—É—Ç —Å—Ç–∞–≤–ª—é –∫–æ–ª-–≤–æ —ç–ø–æ—Ö = 7 (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º + –±–µ–∑ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è)):
```bash
poetry run python -m two_tower_recsys.pipelines.train_pipeline trainer.max_epochs=7
```

# Production preparation

1. —ç–∫—Å–ø–æ—Ä—Ç scoring‚Äë–º–æ–¥—É–ª—è (–ø–∞—Ä–∞ user_idx, item_idx -> score) –≤ ONNX:
   ```bash
   poetry run python -m two_tower_recsys.pipelines.export_onnx_pipeline
   ```
   –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   * `artifacts/model_scoring.onnx`

2. –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å—É –º–æ–¥–µ–ª–∏ –Ω—É–∂–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã:
   * `artifacts/model.ckpt` - –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏
   * `artifacts/item_embeddings.pt` - —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ñ–∏–ª—å–º–æ–≤
   * `data/processed/user2idx.json` - –º–∞–ø–ø–∏–Ω–≥ userId –≤ user_idx (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è)
   * `data/processed/item2idx.json` - –º–∞–ø–ø–∏–Ω–≥ movieId –≤ item_idx
   
   **–ë–õ–ê–ì–û**, —á—Ç–æ –æ–Ω–∏ —É–∂–µ –≤—Å–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª–∏—Å—å –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è)

# Infer

1. –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–µ—Ä (–≤—Ö–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å, –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å, —Ä–∞–±–æ—Ç–∞–µ—Ç python-–ø–∞–∫–µ—Ç two_tower_recsys –ª–æ–∫–∞–ª—å–Ω–æ)
   ```bash
   poetry run python -m two_tower_recsys.pipelines.infer_pipeline infer.user_id=1 infer.k=10
   ```
   –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–æ–Ω—Ü–µ –∫–æ–º–∞–Ω–¥—ã –æ—Ç–≤–µ—á–∞—é—Ç –∑–∞:
   * `user_id` - –∑–∞ –Ω–æ–º–µ—Ä –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ–¥–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å —Ñ–∏–ª—å–º—ã
   * `k` - –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å–º–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –º—ã —Ö–æ—Ç–∏–º –≤—ã–±—Ä–∞—Ç—å

   –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ `JSON`

2. MLflow Serving (HTTP) –∏–Ω—Ñ–µ—Ä
   —Å–±–æ—Ä–∫–∞:
   ```bash
   poetry run python -m two_tower_recsys.pipelines.package_mlflow_pipeline
   ```
   —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞–¥—ë—Ç—Å—è –≤ artifacts/mlflow_model/

   –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞:
   ```bash
   poetry run mlflow models serve -m artifacts/mlflow_model -p 5000 --host 127.0.0.1 --env-manager local
   ```
   –Ω—É –∏ –∫–æ–Ω–µ—á–Ω–æ –∂–µ –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏:
   ```bash
   curl -X POST http://127.0.0.1:5000/invocations \
     -H "Content-Type: application/json" \
     -d '{"dataframe_split": {"columns": ["user_id","k"], "data": [[1,10]]}}'
   ```
   –ø–æ–¥ –∫–ª—é—á—ë–º `"data"` –≤—ã—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—ë —Ç–µ –∂–µ `user_id` –∏ `k`

